<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{base::Layout(~{::section})}">
<head>

    <meta charset="UTF-8">
    <title>Send Message</title>
    <style>
        .search-container {
            position: relative;
        }

        .search-result {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1050; /* Higher than Bootstrap cards */
            background: white;
            border: 1px solid #ddd;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .search-result a {
            cursor: pointer;
        }
    </style>
</head>
<body>
<section>
    <div class="container">
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card-header fs-3">Send Message</div>
                <hr/>

                <form id="messageForm">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="messageType" class="form-label">Message Type</label>
                            <select id="messageType" name="messageType" class="form-select">
                                <option value="">Select Message Type</option>
                                <option value="complaint">Complaint</option>
                                <option value="notification">Notification</option>
                            </select>
                        </div>
                    </div>

                    <div id="recipientTypeDiv" class="row mb-3" style="display: none;">
                        <div class="col-md-3">
                            <label for="recipientType" class="form-label">Recipient Type</label>
                            <select id="recipientType" name="recipientType" class="form-select">
                                <option value="">Select Recipient Type</option>
                                <option value="ALL">All</option>
                                <option value="CLASS">Class</option>
                                <option value="STUDENT">Student</option>
                            </select>
                        </div>
                    </div>

                    <div id="studentSelector" class="search-container my-3" style="display: none;">
                        <input onkeyup="searchStuName()" type="text" class="form-control" id="search-input" placeholder="Search student name">
                        <div class="search-result">

                        </div>
                        <hr>
                        <div class="accordion mb-3" id="studentDetailAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingStudentDetail">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStudentDetail" aria-expanded="false" aria-controls="collapseStudentDetail">
                                        View Student & Academic Details
                                    </button>
                                </h2>
                                <div id="collapseStudentDetail" class="accordion-collapse collapse" aria-labelledby="headingStudentDetail" data-bs-parent="#studentDetailAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="card border-success">
                                                    <h5 class="card-header">Student Detail</h5>
                                                    <ul class="list-group list-group-flush">
                                                        <li class="list-group-item studname"><strong>Student Name:</strong></li>
                                                        <li class="list-group-item fname"><strong>Father Name:</strong></li>
                                                        <li class="list-group-item mname"><strong>Mother Name:</strong></li>
                                                        <li class="list-group-item contactno contact-update-btn"><strong>Contact No:</strong></li>
                                                    </ul>
                                                </div>
                                            </div>

                                            <div class="col-sm-6">
                                                <div class="card border-success">
                                                    <h5 class="card-header">Academic Detail</h5>
                                                    <ul class="list-group list-group-flush">
                                                        <li class="list-group-item cmedium"><strong>Medium: </strong></li>
                                                        <li class="list-group-item cgrade"><strong>Class: </strong></li>
                                                        <li class="list-group-item csection"><strong>Section: </strong></li>
                                                        <li class="list-group-item csr"><strong>SR No: </strong></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4" id="smsSection" style="display: none;">
                            <div class="col-md-6">
                                <h5>Message History</h5>
                                <table class="table table-bordered" id="smsMessagesTable">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Subject</th>
                                        <th>Date</th>
                                        <th>Action/Status</th> <!-- New column -->
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <!-- Dynamically loaded via JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6" id="conversationDiv" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <h5 class="mb-0 me-2">Conversation</h5>
                                    <h4 id="smsSubject" class="mb-0"></h4>
                                </div>
                                <div id="conversationTimeline"
                                     class="border rounded p-3"
                                     style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                    <!-- Messages will appear here -->
                                </div>
                            </div>
                        </div>

                    </div>


                    <div id="classSectionSelector" class="row mb-3" style="display: none;">
                        <div class="col-md-3">
                            <label for="grade" class="form-label">Grade</label>
                            <select id="grade" name="grade" class="form-select">
                                <option value="">Select Grade</option>
                                <option th:each="grade : ${grades}" th:value="${grade.id}" th:text="${grade.gradeName}">Grade</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="section" class="form-label">Section</label>
                            <select id="section" name="section" class="form-select">
                                <option value="">Select Section</option>
                                <option th:each="section : ${sections}" th:value="${section.id}" th:text="${section.sectionName}">Section</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="sendNewMessage"  class="btn btn-primary mt-3">Send New Message</button>
                </form>
            </div>
        </div>
    </div>
    <div id="NotificationList"></div>

    <!-- Modal -->
    <div class="modal fade" id="newMessageModal" tabindex="-1" role="dialog" aria-labelledby="newMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="newMessageModalLabel">New Message</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <div class="modal-body">
                    <!-- Student Details -->
                    <div class="mb-3">
                        <strong>Name:</strong> <span id="studentName"></span><br>
                        <strong>Class:</strong> <span id="studentClass"></span><br>
                        <strong>Parent Name:</strong> <span id="studentParent"></span>
                    </div>

                    <!-- Message Heading -->
                    <div class="form-group">
                        <label for="messageHeading">Heading</label>
                        <input type="text" class="form-control" id="messageHeading" placeholder="Enter message heading">
                    </div>

                    <!-- Message Text -->
                    <div class="form-group">
                        <label for="messageText">Message</label>
                        <textarea class="form-control" id="messageText" rows="4" placeholder="Type your message here..."></textarea>
                    </div>

                    <div class="text-danger d-none" id="modalError"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="submitNewMessage()">Send</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="notificationMessageModal" tabindex="-1" aria-labelledby="addConversationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="modal-title mb-1" id="notificationMessageModalLabel">Send Notification</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <small id="modalMessageDetails" class="text-muted"></small>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <!-- Message Heading Field -->
                    <div class="form-group mb-3">
                        <label for="notificationHeading" class="form-label">Message Heading</label>
                        <input type="text" class="form-control" id="notificationHeading" placeholder="Enter message heading">
                    </div>

                    <!-- Message Body Field -->
                    <div class="form-group">
                        <label for="notificationTextArea" class="form-label">Message</label>
                        <textarea class="form-control" rows="5" id="notificationTextArea" placeholder="Type your message here..."></textarea>
                    </div>

                    <div class="text-danger d-none" id="notificationModalError"></div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="sendNotification()">Send Message</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>

            </div>
        </div>
    </div>




    <!-- Add SMS Conversation Modal -->
    <div class="modal fade" id="addConversationModal" tabindex="-1" aria-labelledby="addConversationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="addConversationModalLabel">Add SMS Conversation</h5>
                    <!-- Close Button (X) -->
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <p><strong>Student Name:</strong> <span id="modalStudentName"></span></p>
                    <p><strong>Message Text:</strong> <span id="modalMessageText"></span></p>

                    <!-- New Selector for "SCHOOL" or "STUDENT" -->
                    <div class="mb-3">
                        <label for="initiatedBy" class="form-label">Initiated By</label>
                        <select class="form-select" id="initiatedBy" required>
                            <option value="SCHOOL">SCHOOL</option>
                            <option value="STUDENT">STUDENT</option>
                        </select>
                    </div>

                    <!-- Textarea for Conversation -->
                    <textarea class="form-control" rows="5" id="conversationTextArea" placeholder="Type your message here..."></textarea>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <!-- Send Button -->
                    <button type="button" class="btn btn-success" onclick="sendSmsConversation()">Send</button>
                    <!-- Cancel Button -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>





    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/toastr.min.js"></script>
    <script type="text/javascript">
        let selectedStudent = null;
        $(document).ready(function () {
            $('#messageType').change(function () {
                selectedStudent = null;
                selectedMessageIdForConversation = null;
                resetMessageForm();
                const messageType = $(this).val();
                $('#recipientTypeDiv').hide();
                $('#studentSelector').hide();
                $('#classSectionSelector').hide();

                if (messageType === 'complaint') {
                    $('#studentSelector').show();
                } else if (messageType === 'notification') {
                    $('#recipientTypeDiv').show();
                }
            });

            $('#recipientType').change(function () {
                const recipientType = $(this).val();
                $('#studentSelector').hide();
                $('#classSectionSelector').hide();

                if (recipientType === 'ALL') {
                    // No extra input
                } else if (recipientType === 'CLASS') {
                    $('#classSectionSelector').show();
                } else if (recipientType === 'STUDENT') {
                    $('#studentSelector').show();
                }
            });
        });



        const searchStuName=() =>{
            let query=$("#search-input").val();
            console.log('searched.....'+query);
            if(query.trim().length>2){

                //Sending request to server
                let url = `${window.location.origin}/searchStudentForFeePage/${query}`;
                fetch(url).then(response=>{
                    return response.json();
                }).then((data)=>{
                    console.log(data);
                    let text = `<div class='list-group'>`;

                    data.forEach((student) =>{
                        text+=`<a onclick="loadStudentData(${student.id})" th:href="#" class='list-group-item list-group-item-action'> ${student.student.studentName} / ${student.student.fatherName} / ${student.grade.gradeName}-${student.section.sectionName}</a>`;
                    });

                    text+=`</div>`;
                    $(".search-result").html(text);
                    $(".search-result").show();
                });


            } else{
                $(".search-result").hide();
            }
        }
        selectedStudent;
        const loadStudentData=(id)=>{
            $(".search-result").hide();
            $("#search-input").val('');
            if(id>0){

                console.log("id::::"+id);
                let url = `${window.location.origin}/getStudentDetailForDiscount/${id}`;
                fetch(url).then(response => {
                    return response.json();
                }).then((data) => {
                    console.log("data----"+data);
                    console.log("data.studen--t"+data.student);
                    if('noAcademicStudent' in data){
                        //toastr["warning"](data.noAcademicStudent,"Message");
                        showWarningMsg("warning",data.noAcademicStudent,"Message");
                    }
                    else{
                        selectedStudent = data.student
                        $(".studname").html(`<strong>Student Name: </strong> ${data.student.student.studentName} <span class="badge rounded-pill ${data.countStu=='OLD'?'bg-primary':'bg-success'}"> <b>${data.countStu}</b> </span>`);
                        $(".fname").html(`<strong>Father Name: </strong> ${data.student.student.fatherName}`);
                        $(".mname").html(`<strong>Mother Name: </strong> ${data.student.student.motherName}`);
                        $(".contactno").html(`<strong>Contact No: </strong> ${data.student.student.mobile1}`);

                        $(".cmedium").html(`<strong>Medium: </strong> ${data.student.medium.mediumName}`);
                        $(".cgrade").html(`<strong>Class: </strong> ${data.student.grade.gradeName}`);
                        $(".csection").html(`<strong>Section: </strong> ${data.student.section.sectionName}`);
                        $(".csr").html(`<strong>SR No: </strong> ${data.student.classSrNo==null?"":data.student.classSrNo}`);
                        // ✅ Set the accordion title
                        let name = data.student.student.studentName;
                        let grade = data.student.grade.gradeName;
                        let section = data.student.section.sectionName;
                        $("#headingStudentDetail button").html(`${name} / ${grade}-${section}`);
                    }
                    let messageType = $("#messageType").val();

                    if (messageType==="complaint" ) {
                        loadSmsMessagesForStudent(id);
                        $("#conversationTimeline").html("");
                        $("#smsSubject").html("")
                    }

                });
            }
        }

        function showWarningMsg(msgType, msg, headerValue){
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-top-right",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "600",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }
            toastr[msgType](msg,headerValue);
        }

        const loadSmsMessagesForStudent = (studentId) => {
            let url = `${window.location.origin}/message/getSmsMessagesByStudent/${studentId}`;
            fetch(url)
                .then(res => res.json())
                .then(messages => {
                    $('#smsSection').show();
                    let tbody = $('#smsMessagesTable tbody');
                    tbody.empty();
                    console.log("messages.length--->"+messages.length);
                    $('#conversationArea').val('');
                    if (!Array.isArray(messages) || messages.length === 0) {
                        console.log("inside 0 rows");
                        let row = '<tr><td colspan="3" class="text-center text-muted">No messages found</td></tr>';
                        tbody.append(row);
                        return;
                    }
                    let counter = 1
                    messages.forEach(msg => {
                        let dt = msg.sentAt
                            ? new Date(msg.sentAt).toISOString().split('T')[0] // Extracts "2025-01-22"
                            : '';

                        if (dt) {
                            let dateObj = new Date(dt);
                            dt = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                            dt = dt.replaceAll(" ","/");
                        }
                        let resolveBtn = msg.resolution === 'RESOLVED'
                            ? '<span class="text-success fw-bold">RESOLVED</span>'
                            : `<button class="btn btn-sm btn-primary me-1" onclick="resolveSmsMessage(${msg.id}, this)">Resolve</button>`;
                        console.log("msg.status--->"+msg.resolution);
                        let convoBtn = msg.resolution != 'RESOLVED'?`<button class="btn btn-sm btn-warning text-white" onclick="openAddConversationModal(${msg.id},'${msg.smsHeading}')">Add Conversation</button>`:``;

                        let row = `<tr onclick="loadSmsConversations(${msg.id})" style="cursor:pointer">
                            <td>${counter}</td>
                            <td>${msg.smsHeading}</td>
                            <td>${dt}</td>
                            <td>${resolveBtn}${convoBtn}</td>
                        </tr>`;
                        console.log("row-->"+row);
                        tbody.append(row);
                        counter++;
                    });
                });
        };

        const resolveSmsMessage = (messageId, button) => {
            const confirmed = confirm("Are you sure you want to mark this message as RESOLVED?");
            if (!confirmed) return;

            const url = `${window.location.origin}/message/resolveSmsMessage/${messageId}`;

            fetch(url, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        $(button).replaceWith('<span class="text-success fw-bold">RESOLVED</span>');
                    } else {
                        alert("Failed to resolve message.");
                    }
                })
                .catch(err => {
                    console.error("Error resolving message:", err);
                    alert("Error resolving message.");
                });
        };


        const openAddConversationModal = (messageId, messageText) => {
            selectedMessageIdForConversation = messageId;
            $('#modalMessageText').text(messageText);
            $('#conversationTextArea').val('');
            $('#addConversationModal').modal('show');
        };



        const loadSmsConversations = (messageId) => {
            const url = `${window.location.origin}/message/getSmsConversationsByMessage/${messageId}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const heading = data.smsHeading;
                    const conversations = data.conversations;

                    // Set the heading
                    $("#smsSubject").text(heading);

                    $('#conversationDiv').show();
                    conversations.sort((a, b) => new Date(a.sentAt) - new Date(b.sentAt));

                    let timelineHTML = '';
                    conversations.forEach(conv => {
                        const by = conv.initiatedBy;
                        const time = new Date(conv.sentAt).toLocaleString();

                        const tick = conv.seen ? '<span style="color: #0ea5e9;">&#10004;&#10004;</span>' : '';

                        const alignClass = (by === 'SCHOOL') ? 'text-start' : 'text-end';
                        const bubbleClass = (by === 'SCHOOL') ? 'bg-light' : 'bg-primary text-white';

                        timelineHTML += `
                    <div class="${alignClass} mb-2">
                        <span class="d-inline-block px-3 py-2 border rounded ${bubbleClass}" style="max-width: 70%;">
                            <div class="small mb-1">
                                <strong>${by}</strong> - ${time} ${tick}
                            </div>
                            <div>${conv.message}</div>
                        </span>
                    </div>
                `;
                    });

                    $("#conversationTimeline").html(timelineHTML);

                    // Auto-scroll to bottom
                    const convoDiv = document.getElementById("conversationTimeline");
                    convoDiv.scrollTop = convoDiv.scrollHeight;
                });
        };


        $('form').on('submit', function(e) {
            e.preventDefault(); // Prevent form submission
        });

        const sendSmsConversation = () => {
            const message = $('#conversationTextArea').val().trim();
            const initiatedBy = document.getElementById('initiatedBy').value; // Get the selected value
            if (!message) {
                alert("Please enter a message.");
                return;
            }

            const url = `${window.location.origin}/message/sendSmsConversation`;
            console.log("selectedMessageIdForConversation--->"+selectedMessageIdForConversation);
            console.log("message-->"+message);
            console.log("initiatedBy--->"+initiatedBy);
            const payload = {
                messageId: selectedMessageIdForConversation,
                message: message,
                initiatedBy:initiatedBy
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (response.ok) {
                        $('#addConversationModal').modal('hide');
                        alert("Conversation sent successfully!");

                        // Reload conversation timeline
                        loadSmsConversations(selectedMessageIdForConversation);
                    } else {
                        alert("Failed to send conversation.");
                    }
                })
                .catch(error => {
                    console.error("Error sending conversation:", error);
                    alert("Error sending conversation.");
                });
        };


        function resetMessageForm() {
            // Reset student search input
            $('#search-input').val('');
            $("#headingStudentDetail button").html('View Student & Academic Details');
            // Hide accordion and search results
            $(".studname").html(`<strong>Student Name: </strong>  `);
            $(".fname").html(`<strong>Father Name: </strong> `);
            $(".mname").html(`<strong>Mother Name: </strong> `);
            $(".contactno").html(`<strong>Contact No: </strong> `);

            $(".cmedium").html(`<strong>Medium: </strong> `);
            $(".cgrade").html(`<strong>Class: </strong> `);
            $(".csection").html(`<strong>Section: </strong> `);
            $(".csr").html(`<strong>SR No: </strong> `);
            $('#studentSelector').hide();
            $('#studentAccordion').collapse('hide');
            $('.search-result').hide();

            // Clear student details
            $('#studentName').text('');
            $('#studentEmail').text('');
            $('#studentPhone').text('');

            // Hide and clear SMS section
            $('#smsSection').hide();
            $('#smsMessagesTable tbody').empty();
            $('#conversationTimeline').val('');

            // Optionally reset message input and status
            $('#messageInput').val('');
            $('#sendStatus').html('');

            // Reset currentMessageId
            currentMessageId = null;
        }

        $(document).ready(function () {
            // Open the modal when called from the button
            window.openAddConversationModal = function (messageId, messageText) {
                console.log("openAddConversationModal triggered with messageId:", messageId, "and messageText:", messageText);

                // Assign values to modal content
                selectedMessageIdForConversation = messageId;
                $('#modalMessageText').text(messageText);
                $('#conversationTextArea').val('');

                // Debug modal visibility
                console.log("Attempting to open modal with ID:", '#addConversationModal');
                $('#addConversationModal').modal('show');
            };

            // Prevent default form submission if inside a form element
            $('form').on('submit', function(e) {
                e.preventDefault();  // Stop the page from refreshing
            });
        });



        document.getElementById("sendNewMessage").addEventListener("click", function () {
            let messageType = $("#messageType").val();

            if (messageType==="complaint" ) {
                if(!selectedStudent){
                    alert("Please select a student first.");
                    return;
                }
                document.getElementById("studentName").innerText = selectedStudent.student.studentName;

                document.getElementById("studentClass").innerText = `${selectedStudent.grade.gradeName}/${selectedStudent.section.sectionName}`
                document.getElementById("studentParent").innerText = `${selectedStudent.student.fatherName}/${selectedStudent.student.motherName}`

                document.getElementById("messageHeading").value = "";
                document.getElementById("messageText").value = "";
                document.getElementById("modalError").classList.add("d-none");

                $('#newMessageModal').modal('show');
            }
            if (messageType === "notification") {
                let recipientType = $("#recipientType").val();
                if (recipientType === "") {
                    alert("Please select Recipient type to proceed");
                    return;
                }
                if (recipientType === "ALL") {
                    let messageDetails = `Type: <strong>${messageType.toUpperCase()}</strong> | Recipient: <strong>${recipientType.toUpperCase()}</strong>`;
                    $("#modalMessageDetails").html(messageDetails);
                    $("#notificationMessageModal").modal("show");
                }
                else if (recipientType === "CLASS") {
                    let messageDetails = `Type: <strong>${messageType.toUpperCase()}</strong> | Recipient: <strong>${recipientType.toUpperCase()}</strong>`;
                    const selectedClass = $("#grade option:selected").text();
                    const selectedSection = $("#section option:selected").text();
                    if(selectedClass==='Select Grade'){
                        alert("Please select Grade to proceed");
                        return;
                    }
                    if(selectedSection==='Select Section'){
                        alert("Please select Section to proceed");
                        return;
                    }
                    messageDetails += ` | Class: <strong>${selectedClass}</strong> - Section: <strong>${selectedSection}</strong>`;
                    $("#modalMessageDetails").html(messageDetails);
                    $("#notificationMessageModal").modal("show");
                }
                else if (recipientType === "STUDENT") {
                    let messageDetails = `Type: <strong>${messageType.toUpperCase()}</strong> | Recipient: <strong>${recipientType.toUpperCase()}</strong>`;

                    if(!selectedStudent){
                        alert("Please select Student to proceed");
                        return;
                    }
                    let name = selectedStudent.student.studentName;
                    let grade = selectedStudent.grade.gradeName;
                    let section = selectedStudent.section.sectionName;
                    const selectedStudentText = `${name} / ${grade}-${section}`;
                    messageDetails += ` | Student: <strong>${selectedStudentText}</strong>`;
                    $("#modalMessageDetails").html(messageDetails);
                    $("#notificationMessageModal").modal("show");
                }


            }




        });


        function submitNewMessage() {
            const heading = document.getElementById("messageHeading").value.trim();
            const message = document.getElementById("messageText").value.trim();

            if (!heading || !message) {
                const errorDiv = document.getElementById("modalError");
                errorDiv.innerText = "Both heading and message are required.";
                errorDiv.classList.remove("d-none");
                return;
            }
            if(!selectedStudent){
                const errorDiv = document.getElementById("modalError");
                errorDiv.innerText = "No Student selected";
                errorDiv.classList.remove("d-none");
                return;
            }
            // Proceed to send via AJAX (optional)
            console.log("Sending:", { heading, message, student: selectedStudent.id });
            sendNewMessage(heading, message, selectedStudent.id)


            // Close modal and show success
            $('#newMessageModal').modal('hide');
            alert("Message sent!");
        }

        function sendNewMessage(message, smsConversation, studentId) {
            const url = `${window.location.origin}/message/sendNewMessage`;
            console.log("message-->"+message);
            console.log("smsConversation-->"+smsConversation);
            console.log("student--->"+studentId)
            const payload = {
                heading: message,
                message: smsConversation,
                studentId: studentId
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (response.ok) {
                        loadSmsMessagesForStudent(studentId);
                        console.log("Server response:", response);

                    } else {
                        console.error("Error sending message:", error);
                        alert("Failed to send message.");
                    }
                })
                .catch(error => {
                    console.error("Error sending conversation:", error);
                    alert("Error sending conversation.");
                });


        }


        function sendNotification() {
            const heading = document.getElementById("notificationHeading").value.trim();
            const message = document.getElementById("notificationTextArea").value.trim();
            const errorDiv = document.getElementById("notificationModalError");

            const recipientType = document.getElementById("recipientType")?.value;
            const messageType = document.getElementById("messageType")?.value;

            // Validation
            if (!heading || !message || !recipientType || !messageType) {
                errorDiv.textContent = "Please fill all required fields.";
                errorDiv.classList.remove("d-none");
                return;
            }

            // Build request payload
            const requestData = {
                heading: heading,
                message: message,
                messageType: messageType,
                recipientType: recipientType
            };

            if (recipientType === "CLASS") {
                const selectedClass = document.getElementById("grade")?.value;
                const selectedSection = document.getElementById("section")?.value;

                if (!selectedClass || !selectedSection) {
                    errorDiv.textContent = "Please select class and section.";
                    errorDiv.classList.remove("d-none");
                    return;
                }

                requestData.classId = selectedClass;
                requestData.sectionId = selectedSection;
            } else if (recipientType === "STUDENT") {
                if(!selectedStudent){
                    errorDiv.textContent = "Please enter a student ID.";
                    errorDiv.classList.remove("d-none");
                    return;
                }


                requestData.studentId = selectedStudent.id;
            }
            const url = `${window.location.origin}/message/sendNewNotification`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        clearNotificationModalFields()
                        return response.text(); // Assuming response is plain text
                    } else {
                        throw new Error("Failed to send Notification.");
                    }
                })
                .then(data => {
                    const infoMessage = "Notification Sent Successfully.";
                    if (infoMessage) {
                        //toastr.success(successMessage);
                        toastr["info"](infoMessage,"Info");
                        toastr.options = {
                            "closeButton": true,
                            "debug": false,
                            "newestOnTop": true,
                            "progressBar": false,
                            "positionClass": "toast-top-right",
                            "preventDuplicates": false,
                            "onclick": null,
                            "showDuration": "600",
                            "hideDuration": "1000",
                            "timeOut": "5000",
                            "extendedTimeOut": "1000",
                            "showEasing": "swing",
                            "hideEasing": "linear",
                            "showMethod": "fadeIn",
                            "hideMethod": "fadeOut"
                        }
                    }

                })
                .catch(error => {
                    const errorMessage = error.message;
                    if (errorMessage) {
                        //toastr.error(errorMessage);
                        toastr["error"](errorMessage, "Error");
                        toastr.options = {
                            "closeButton": true,
                            "debug": false,
                            "newestOnTop": false,
                            "progressBar": false,
                            "positionClass": "toast-top-right",
                            "preventDuplicates": false,
                            "onclick": null,
                            "showDuration": "500",
                            "hideDuration": "1000",
                            "timeOut": "5000",
                            "extendedTimeOut": "1000",
                            "showEasing": "swing",
                            "hideEasing": "linear",
                            "showMethod": "fadeIn",
                            "hideMethod": "fadeOut"
                        }
                    }
                });

        }


        function fetchMessagesAndPopulateTable() {
            const messageType = document.getElementById("messageTypeSelect")?.value;
            const recipientType = document.getElementById("recipientTypeSelect")?.value;

            const requestData = {
                messageType: messageType,
                recipientType: recipientType
            };

            if (recipientType === "CLASS") {
                const selectedClass = document.getElementById("classSelect")?.value;
                const selectedSection = document.getElementById("sectionSelect")?.value;

                if (!selectedClass || !selectedSection) {
                    alert("Please select both class and section.");
                    return;
                }

                requestData.className = selectedClass;
                requestData.section = selectedSection;

            } else if (recipientType === "STUDENT") {
                const studentId = document.getElementById("studentIdInput")?.value;

                if (!studentId) {
                    alert("Please enter a student ID.");
                    return;
                }

                requestData.studentId = studentId;
            }

            fetch('/api/sms/fetch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    const tableHtml = `
            <table id="messagesTable" class="table table-bordered table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th>Message Type</th>
                        <th>Recipient Type</th>
                        <th>Class</th>
                        <th>Section</th>
                        <th>Student</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        `;

                    document.getElementById("NotificationList").innerHTML = tableHtml;

                    $('#messagesTable').DataTable({
                        data: data,
                        columns: [
                            { data: 'messageType' },
                            { data: 'recipientType' },
                            { data: 'className', defaultContent: '' },
                            { data: 'section', defaultContent: '' },
                            { data: 'studentName', defaultContent: '' }
                        ]
                    });
                })
                .catch(error => {
                    console.error("Error fetching messages:", error);
                    alert("Failed to fetch messages.");
                });
        }

        function clearNotificationModalFields() {
            document.getElementById("notificationHeading").value = "";
            document.getElementById("notificationTextArea").value = "";
            document.getElementById("notificationModalError").classList.add("d-none");
            document.getElementById("notificationModalError").innerText = "";
        }

    </script>
</section>
</body>
</html>
